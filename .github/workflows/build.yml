name: Build Enhanced GPS APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Позволяет запустить вручную

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    # ✅ НОВЫЙ ШАГ: Создание local.properties
    - name: Create local.properties
      run: |
        echo "Creating local.properties for GitHub Actions..."
        cat > local.properties << 'EOF'
        # Auto-generated by GitHub Actions
        sdk.dir=/usr/local/lib/android/sdk
        EOF
        echo "✅ local.properties created successfully"
        cat local.properties
        
    - name: Create enhanced directories
      run: |
        mkdir -p app/src/main/java/io/github/jqssun/gpssetter/hook
        mkdir -p app/src/main/java/io/github/jqssun/gpssetter/config
        
    - name: Create EnhancedLocationHook.java
      run: |
        cat > app/src/main/java/io/github/jqssun/gpssetter/hook/EnhancedLocationHook.java << 'EOFHOOK'
        package io.github.jqssun.gpssetter.hook;
        
        import android.location.Location;
        import android.location.LocationManager;
        import android.net.wifi.WifiManager;
        import android.telephony.TelephonyManager;
        import android.os.Build;
        import de.robv.android.xposed.XC_MethodHook;
        import de.robv.android.xposed.XposedBridge;
        import de.robv.android.xposed.XposedHelpers;
        import de.robv.android.xposed.callbacks.XC_LoadPackage;
        
        public class EnhancedLocationHook {
            
            private static final String TAG = "EnhancedGPS";
            public static double targetLatitude = 0.0;
            public static double targetLongitude = 0.0;
            public static float targetAltitude = 0.0f;
            public static float targetAccuracy = 5.0f;
            
            public static boolean aggressiveMode = true;
            public static boolean blockNetworkLocation = true;
            
            public static void initHook(XC_LoadPackage.LoadPackageParam lpparam) {
                XposedBridge.log(TAG + ": Initializing enhanced hooks for " + lpparam.packageName);
                
                try {
                    // Hook getLatitude
                    XposedHelpers.findAndHookMethod(
                        Location.class,
                        "getLatitude",
                        new XC_MethodHook() {
                            @Override
                            protected void afterHookedMethod(MethodHookParam param) throws Throwable {
                                if (aggressiveMode || targetLatitude != 0.0) {
                                    param.setResult(targetLatitude);
                                    XposedBridge.log(TAG + ": Latitude overridden -> " + targetLatitude);
                                }
                            }
                        }
                    );
                    
                    // Hook getLongitude
                    XposedHelpers.findAndHookMethod(
                        Location.class,
                        "getLongitude",
                        new XC_MethodHook() {
                            @Override
                            protected void afterHookedMethod(MethodHookParam param) throws Throwable {
                                if (aggressiveMode || targetLongitude != 0.0) {
                                    param.setResult(targetLongitude);
                                    XposedBridge.log(TAG + ": Longitude overridden -> " + targetLongitude);
                                }
                            }
                        }
                    );
                    
                    // Hook isMock
                    XposedHelpers.findAndHookMethod(
                        Location.class,
                        "isMock",
                        new XC_MethodHook() {
                            @Override
                            protected void afterHookedMethod(MethodHookParam param) throws Throwable {
                                param.setResult(false);
                                XposedBridge.log(TAG + ": isMock() -> false");
                            }
                        }
                    );
                    
                    // Hook isFromMockProvider (Android 6+)
                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                        XposedHelpers.findAndHookMethod(
                            Location.class,
                            "isFromMockProvider",
                            new XC_MethodHook() {
                                @Override
                                protected void afterHookedMethod(MethodHookParam param) throws Throwable {
                                    param.setResult(false);
                                    XposedBridge.log(TAG + ": isFromMockProvider() -> false");
                                }
                            }
                        );
                    }
                    
                    // Block WiFi scanning
                    try {
                        XposedHelpers.findAndHookMethod(
                            WifiManager.class,
                            "getScanResults",
                            new XC_MethodHook() {
                                @Override
                                protected void afterHookedMethod(MethodHookParam param) throws Throwable {
                                    param.setResult(new java.util.ArrayList<>());
                                    XposedBridge.log(TAG + ": WiFi scan results blocked");
                                }
                            }
                        );
                        
                        XposedHelpers.findAndHookMethod(
                            WifiManager.class,
                            "startScan",
                            new XC_MethodHook() {
                                @Override
                                protected void beforeHookedMethod(MethodHookParam param) throws Throwable {
                                    param.setResult(false);
                                    XposedBridge.log(TAG + ": WiFi scan blocked");
                                }
                            }
                        );
                    } catch (Throwable t) {
                        XposedBridge.log(TAG + ": WiFi hook error: " + t.getMessage());
                    }
                    
                    // Block Cell Tower info
                    try {
                        XposedHelpers.findAndHookMethod(
                            TelephonyManager.class,
                            "getAllCellInfo",
                            new XC_MethodHook() {
                                @Override
                                protected void afterHookedMethod(MethodHookParam param) throws Throwable {
                                    param.setResult(new java.util.ArrayList<>());
                                    XposedBridge.log(TAG + ": Cell info blocked");
                                }
                            }
                        );
                        
                        XposedHelpers.findAndHookMethod(
                            TelephonyManager.class,
                            "getCellLocation",
                            new XC_MethodHook() {
                                @Override
                                protected void afterHookedMethod(MethodHookParam param) throws Throwable {
                                    param.setResult(null);
                                    XposedBridge.log(TAG + ": Cell location blocked");
                                }
                            }
                        );
                    } catch (Throwable t) {
                        XposedBridge.log(TAG + ": Cell hook error: " + t.getMessage());
                    }
                    
                    XposedBridge.log(TAG + ": All hooks initialized successfully");
                    
                } catch (Throwable t) {
                    XposedBridge.log(TAG + ": Critical error during hook initialization: " + t.getMessage());
                }
            }
            
            public static void setTargetLocation(double lat, double lon, float alt, float acc) {
                targetLatitude = lat;
                targetLongitude = lon;
                targetAltitude = alt;
                targetAccuracy = acc;
                XposedBridge.log(TAG + ": Target location set: " + lat + ", " + lon);
            }
            
            public static void setAggressiveMode(boolean enabled) {
                aggressiveMode = enabled;
                XposedBridge.log(TAG + ": Aggressive mode: " + (enabled ? "ENABLED" : "DISABLED"));
            }
            
            public static void setBlockNetworkLocation(boolean enabled) {
                blockNetworkLocation = enabled;
                XposedBridge.log(TAG + ": Block network location: " + (enabled ? "ENABLED" : "DISABLED"));
            }
        }
        EOFHOOK
        
    - name: Build with Gradle
      run: ./gradlew assembleRelease --stacktrace
      
    - name: Sign APK (optional)
      run: |
        echo "APK built successfully"
        find app/build/outputs/apk -name "*.apk" -type f
      
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: EnhancedGPS-APK
        path: app/build/outputs/apk/**/release/*.apk
        retention-days: 30
        
    - name: Create Release on tag
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: app/build/outputs/apk/**/release/*.apk
        body: |
          Enhanced GPS Setter with:
          - Aggressive location hooks
          - WiFi/Cell blocking
          - Mock detection bypass
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
