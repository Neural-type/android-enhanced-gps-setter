name: Build Enhanced GPS APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Позволяет запустить вручную

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Create enhanced directories
      run: |
        mkdir -p app/src/main/java/io/github/jqssun/gpssetter/hook
        mkdir -p app/src/main/java/io/github/jqssun/gpssetter/config
        
    - name: Create EnhancedLocationHook
      run: |
        cat > app/src/main/java/io/github/jqssun/gpssetter/hook/EnhancedLocationHook.java << 'EOF'
        package io.github.jqssun.gpssetter.hook;
        
        import android.location.Location;
        import android.location.LocationManager;
        import de.robv.android.xposed.XC_MethodHook;
        import de.robv.android.xposed.XposedBridge;
        import de.robv.android.xposed.XposedHelpers;
        import de.robv.android.xposed.callbacks.XC_LoadPackage;
        
        public class EnhancedLocationHook {
            private static final String TAG = "EnhancedGPS";
            public static double targetLatitude = 0.0;
            public static double targetLongitude = 0.0;
            public static boolean aggressiveMode = true;
            
            public static void initHook(XC_LoadPackage.LoadPackageParam lpparam) {
                XposedBridge.log(TAG + ": Init for " + lpparam.packageName);
                
                try {
                    XposedHelpers.findAndHookMethod(
                        Location.class, "getLatitude",
                        new XC_MethodHook() {
                            @Override
                            protected void afterHookedMethod(MethodHookParam param) {
                                if (targetLatitude != 0.0) {
                                    param.setResult(targetLatitude);
                                }
                            }
                        }
                    );
                    
                    XposedHelpers.findAndHookMethod(
                        Location.class, "getLongitude",
                        new XC_MethodHook() {
                            @Override
                            protected void afterHookedMethod(MethodHookParam param) {
                                if (targetLongitude != 0.0) {
                                    param.setResult(targetLongitude);
                                }
                            }
                        }
                    );
                    
                    XposedHelpers.findAndHookMethod(
                        Location.class, "isMock",
                        new XC_MethodHook() {
                            @Override
                            protected void afterHookedMethod(MethodHookParam param) {
                                param.setResult(false);
                            }
                        }
                    );
                } catch (Throwable t) {
                    XposedBridge.log(TAG + ": Error: " + t.getMessage());
                }
            }
            
            public static void setTargetLocation(double lat, double lon) {
                targetLatitude = lat;
                targetLongitude = lon;
            }
        }
        EOF
        
    - name: Build with Gradle
      run: ./gradlew assembleRelease --stacktrace
      
    - name: Upload APK artifact
      uses: actions/upload-artifact@v3
      with:
        name: EnhancedGPS-APK
        path: app/build/outputs/apk/release/*.apk
        
    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0-enhanced-${{ github.run_number }}
        name: Enhanced GPS v1.0 Build ${{ github.run_number }}
        files: app/build/outputs/apk/release/*.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
